import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';
import { ArrowRight, CheckCircle, Code, Eye, XCircle, LayoutTemplate } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import Editor from '@monaco-editor/react';
import PreviewFrame from './PreviewFrame';

const HtmlCssResult = ({ results, onBack }) => {
    const navigate = useNavigate();
    const [viewMode, setViewMode] = useState('preview'); // 'preview' or 'code'
    const [codeTab, setCodeTab] = useState('html'); // 'html', 'css', 'js'

    const [currentIndex, setCurrentIndex] = useState(0);

    // Store scores for ALL questions: { [index]: { structure, content, style, total } }
    const [allScores, setAllScores] = useState({});
    const [isScoring, setIsScoring] = useState(true);

    // Refs for ALL questions to run parallel/hidden analysis
    // Structure: refs.current[index] = { user: ref, correct: ref }
    const previewRefs = useRef({});

    // --- Helper to parse code safely ---
    const parseCode = (raw) => {
        try {
            if (!raw) return { html: '', css: '', js: '' };
            if (typeof raw === 'object') return raw;
            return JSON.parse(raw);
        } catch (e) {
            if (typeof raw === 'string') return { html: raw, css: '', js: '' };
            return { html: '', css: '', js: '' };
        }
    };

    // Prepare data for all questions
    const questionsData = useMemo(() => {
        return results.questions.map(q => ({
            ...q,
            userCode: parseCode(q.submission?.submitted_code),
            correctCode: parseCode(q.reference_solution)
        }));
    }, [results]);

    // Current displayed question
    const currentQuestion = questionsData[currentIndex];
    const currentScore = allScores[currentIndex] || { structure: 0, content: 0, style: 0, total: 0 };


    // --- ANALYSIS LOGIC ---
    const analyzeQuestion = useCallback((index) => {
        const refs = previewRefs.current[index];
        if (!refs || !refs.user?.current || !refs.correct?.current) return;

        const userWin = refs.user.current.getWindow();
        const correctWin = refs.correct.current.getWindow();

        if (!userWin || !correctWin || !userWin.document.body || !correctWin.document.body) return;

        const correctDoc = correctWin.document;
        const userDoc = userWin.document;
        const correctElements = Array.from(correctDoc.body.querySelectorAll('*'));

        if (correctElements.length === 0) {
            setAllScores(prev => ({ ...prev, [index]: { structure: 100, content: 100, style: 100, total: 100 } }));
            return;
        }

        let structurePoints = 0;
        let maxStructurePoints = 0;
        let contentPoints = 0;
        let maxContentPoints = 0;
        let stylePoints = 0;
        let maxStylePoints = 0;

        const usedUserElements = new Set();

        correctElements.forEach(correctEl => {
            maxStructurePoints += 1;

            // Find match
            const candidates = Array.from(userDoc.body.getElementsByTagName(correctEl.tagName));
            let bestMatch = null;
            let bestMatchScore = -1;

            candidates.forEach(cand => {
                if (usedUserElements.has(cand)) return;
                let s = 0;
                if (correctEl.id && cand.id === correctEl.id) s += 50;
                if (correctEl.className === cand.className) s += 20;
                if (correctEl.textContent.trim() === cand.textContent.trim()) s += 30;
                if (s > bestMatchScore) { bestMatchScore = s; bestMatch = cand; }
            });

            if (!bestMatch && candidates.length > 0) {
                bestMatch = candidates.find(c => !usedUserElements.has(c));
            }

            if (bestMatch) {
                usedUserElements.add(bestMatch);
                structurePoints += 1;
                // Content
                if (correctEl.children.length === 0 && correctEl.textContent.trim()) {
                    maxContentPoints += 1;
                    if (correctEl.textContent.trim() === bestMatch.textContent.trim()) contentPoints += 1;
                }

                // Style & Geometry
                const expandedStyles = ['display', 'color', 'background-color', 'font-size', 'margin', 'padding', 'border-radius', 'text-align'];
                maxStylePoints += expandedStyles.length + 4; // +4 for bounding box

                const cStyle = correctWin.getComputedStyle(correctEl);
                const uStyle = userWin.getComputedStyle(bestMatch);

                expandedStyles.forEach(p => {
                    if (cStyle.getPropertyValue(p) === uStyle.getPropertyValue(p)) stylePoints += 1;
                });

                const cRect = correctEl.getBoundingClientRect();
                const uRect = bestMatch.getBoundingClientRect();
                if (Math.abs(cRect.width - uRect.width) < 5) stylePoints += 1;
                if (Math.abs(cRect.height - uRect.height) < 5) stylePoints += 1;
                if (Math.abs(cRect.top - uRect.top) < 5) stylePoints += 1;
                if (Math.abs(cRect.left - uRect.left) < 5) stylePoints += 1;

            } else {
                if (correctEl.children.length === 0 && correctEl.textContent.trim()) maxContentPoints += 1;
                maxStylePoints += 12; // Penalty
            }
        });

        const calc = (pts, max) => max > 0 ? Math.round((pts / max) * 100) : 100;
        const sScore = calc(structurePoints, maxStructurePoints);
        const cScore = calc(contentPoints, maxContentPoints);
        const stScore = calc(stylePoints, maxStylePoints);
        const total = Math.round((sScore * 0.3) + (stScore * 0.5) + (cScore * 0.2));

        setAllScores(prev => ({
            ...prev,
            [index]: { structure: sScore, content: cScore, style: stScore, total }
        }));

    }, []);

    useEffect(() => {
        // Run analysis for ALL questions after a delay to let iframes load
        setIsScoring(true);
        const timer = setTimeout(() => {
            questionsData.forEach((_, idx) => {
                analyzeQuestion(idx);
            });
            setIsScoring(false);
        }, 3000); // 3 seconds to ensure all iframes rendered

        return () => clearTimeout(timer);
    }, [questionsData, analyzeQuestion]);


    // Calculate Overall Score
    const scoredQuestionsCount = Object.keys(allScores).length;
    const overallTotal = scoredQuestionsCount > 0
        ? Math.round(Object.values(allScores).reduce((acc, s) => acc + s.total, 0) / scoredQuestionsCount)
        : 0;

    const isOverallPass = overallTotal >= 70;

    // --- UI HELPERS ---
    const Donut = ({ score, color, label, subLabel }) => {
        const isPass = score >= 70;
        const statusColor = isPass ? 'text-green-600' : 'text-orange-500';

        return (
            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 flex flex-col items-center justify-center text-center h-full">
                <div className="relative w-32 h-32 flex items-center justify-center mb-4">
                    <svg className="w-full h-full transform -rotate-90">
                        <circle cx="64" cy="64" r="54" className="stroke-gray-100 dark:stroke-slate-700" strokeWidth="12" fill="none" />
                        <circle
                            cx="64" cy="64" r="54"
                            className={color}
                            strokeWidth="12"
                            fill="none"
                            strokeDasharray="339.29"
                            strokeDashoffset={339.29 - (339.29 * score) / 100}
                            strokeLinecap="round"
                        />
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                        <span className="text-3xl font-bold text-gray-800 dark:text-white">{score}%</span>
                        <span className={`text-xs font-bold uppercase mt-1 ${statusColor}`}>{isPass ? 'PASSED' : 'FAILED'}</span>
                    </div>
                </div>
                <h3 className="font-bold text-gray-800 dark:text-white mb-1">{label}</h3>
                {subLabel && <p className="text-xs text-gray-500 dark:text-gray-400">{subLabel}</p>}
            </div>
        );
    };

    return (
        <div className="min-h-screen bg-gray-50 dark:bg-slate-900 p-6 font-sans transition-colors duration-300">
            <div className="max-w-7xl mx-auto">
                {/* --- 1. HEADER --- */}
                <div className="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6 mb-8">
                    <div className="flex items-center gap-6">
                        <div className="flex items-baseline gap-4">
                            <h1 className="text-2xl font-bold text-gray-900 dark:text-white">Result overview</h1>

                            {/* Tabs container */}
                            <div className="flex gap-2 bg-white dark:bg-slate-800 rounded-lg p-1 border border-gray-200 dark:border-slate-700">
                                {questionsData.map((_, idx) => (
                                    <button
                                        key={idx}
                                        onClick={() => setCurrentIndex(idx)}
                                        className={`px-4 py-1.5 rounded-md text-sm font-semibold transition-colors ${currentIndex === idx
                                            ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 shadow-sm border border-blue-100 dark:border-blue-800'
                                            : 'text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-slate-700'
                                            }`}
                                    >
                                        Question {idx + 1}
                                    </button>
                                ))}
                                <button className="px-4 py-1.5 rounded-md text-sm font-semibold bg-blue-600 text-white shadow-sm">
                                    Overall Result
                                </button>
                            </div>
                        </div>

                        {/* LARGE OVERALL INDICATOR */}
                        <div className="flex items-center gap-2">
                            <span className={`text-4xl font-extrabold ${isOverallPass ? 'text-green-600 dark:text-green-400' : 'text-orange-500 dark:text-orange-400'}`}>
                                {isScoring && scoredQuestionsCount < questionsData.length ? '...' : `${overallTotal}%`}
                            </span>
                            <span className={`text-2xl font-bold uppercase ${isOverallPass ? 'text-green-600 dark:text-green-400' : 'text-orange-500 dark:text-orange-400'}`}>
                                {isOverallPass ? 'PASSED' : 'FAILED'}
                            </span>
                        </div>
                    </div>

                    <button onClick={onBack} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-sm flex items-center gap-2 transition-transform hover:scale-105">
                        Continue to Next Lesson <ArrowRight size={18} />
                    </button>
                </div>

                {/* --- 2. MAIN CONTENT GRID --- */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    {/* Left: Question Info */}
                    <div className="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 flex flex-col justify-start">
                        <div className="flex items-center gap-3 mb-4">
                            <div className="p-2 bg-blue-50 dark:bg-slate-700/50 rounded-lg text-blue-600 dark:text-blue-400">
                                <LayoutTemplate size={20} />
                            </div>
                            <div>
                                <h2 className="text-lg font-bold text-gray-900 dark:text-white">Question {currentIndex + 1}</h2>
                                <p className="text-sm text-gray-500 dark:text-gray-400 font-medium">{currentQuestion.title}</p>
                            </div>
                        </div>
                        <p className="text-gray-600 dark:text-gray-300 text-sm leading-relaxed whitespace-pre-wrap mb-4">{currentQuestion.description}</p>

                        <div style={{ position: 'absolute', opacity: 0, pointerEvents: 'none', width: 0, height: 0, overflow: 'hidden' }}>
                            {questionsData.map((q, idx) => (
                                <div key={`hidden-${idx}`}>
                                    <PreviewFrame
                                        ref={el => { if (!previewRefs.current[idx]) previewRefs.current[idx] = {}; previewRefs.current[idx].user = { current: el }; }}
                                        code={q.userCode}
                                    />
                                    <PreviewFrame
                                        ref={el => { if (!previewRefs.current[idx]) previewRefs.current[idx] = {}; previewRefs.current[idx].correct = { current: el }; }}
                                        code={q.correctCode}
                                    />
                                </div>
                            ))}
                        </div>

                    </div>

                    {/* Right: Question Specific Metric */}
                    <div className="h-full">
                        <Donut
                            score={currentScore.total}
                            color={currentScore.total >= 70 ? "stroke-green-500" : "stroke-orange-500"}
                            label={`QUESTION ${currentIndex + 1} RESULT`}
                            subLabel="HIGH-LEVEL SUMMARY"
                        />
                    </div>
                </div>

                {/* --- 3. COMPARISON & EDITOR SECTION --- */}
                <div className="mb-6 flex items-center justify-center gap-4">
                    <div className="bg-white dark:bg-slate-800 p-1 rounded-lg border border-gray-200 dark:border-slate-700 shadow-sm flex">
                        <button
                            onClick={() => setViewMode('preview')}
                            className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all ${viewMode === 'preview' ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-slate-700'
                                }`}
                        >
                            <Eye size={16} /> Visual Preview
                        </button>
                        <button
                            onClick={() => setViewMode('code')}
                            className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all ${viewMode === 'code' ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-slate-700'
                                }`}
                        >
                            <Code size={16} /> Source Code
                        </button>
                    </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 h-[500px]">
                    {/* --- USER OUTPUT PANEL --- */}
                    <div className="bg-[#1e293b] rounded-xl overflow-hidden shadow-lg flex flex-col border border-gray-700">
                        <div className="bg-[#0f172a] px-4 py-3 flex items-center justify-between border-b border-gray-800">
                            <div className="flex items-center gap-3">
                                <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">YOUR OUTPUT</span>
                                {viewMode === 'code' && (
                                    <div className="flex bg-[#1e293b] rounded-md overflow-hidden ml-4">
                                        {['html', 'css', 'javascript'].map(lang => (
                                            <button
                                                key={lang}
                                                onClick={() => setCodeTab(lang === 'javascript' ? 'js' : lang)}
                                                className={`px-3 py-1 text-[10px] font-bold uppercase transition-colors ${(lang === 'javascript' ? 'js' : lang) === codeTab
                                                    ? 'bg-blue-600 text-white'
                                                    : 'text-gray-500 hover:text-gray-300'
                                                    }`}
                                            >
                                                {lang}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                            {!isScoring && currentScore.total < 100 && (
                                <div className="bg-red-500/20 text-red-400 text-[10px] px-2 py-0.5 rounded border border-red-500/30">
                                    Issues Found
                                </div>
                            )}
                        </div>

                        <div className="flex-1 overflow-hidden relative bg-white">
                            {/* VISUAL PREVIEW */}
                            <div className={`w-full h-full ${viewMode === 'preview' ? 'block' : 'hidden'}`}>
                                {/* We render a visible preview frame specifically for the CURRENT question interaction */}
                                <PreviewFrame code={currentQuestion.userCode} isRestricted={true} />
                            </div>

                            {/* CODE EDITOR */}
                            <div className={`w-full h-full bg-[#1e293b] ${viewMode === 'code' ? 'block' : 'hidden'}`}>
                                <Editor
                                    height="100%"
                                    language={codeTab === 'js' ? 'javascript' : codeTab}
                                    value={currentQuestion.userCode[codeTab]}
                                    theme="vs-dark"
                                    options={{
                                        readOnly: true,
                                        minimap: { enabled: false },
                                        fontSize: 13,
                                        padding: { top: 16 },
                                        lineNumbers: 'on',
                                        fontFamily: "'JetBrains Mono', 'Fira Code', monospace"
                                    }}
                                />
                            </div>
                        </div>
                    </div>

                    {/* --- EXPECTED OUTPUT PANEL --- */}
                    <div className="bg-[#1e293b] rounded-xl overflow-hidden shadow-lg flex flex-col border border-gray-700">
                        <div className="bg-[#0f172a] px-4 py-3 flex items-center justify-between border-b border-gray-800">
                            <div className="flex items-center gap-3">
                                <span className="text-xs font-bold text-blue-400 uppercase tracking-wider">EXPECTED OUTPUT</span>
                                {viewMode === 'code' && (
                                    <div className="flex bg-[#1e293b] rounded-md overflow-hidden ml-4">
                                        {['html', 'css', 'javascript'].map(lang => (
                                            <button
                                                key={lang}
                                                onClick={() => setCodeTab(lang === 'javascript' ? 'js' : lang)}
                                                className={`px-3 py-1 text-[10px] font-bold uppercase transition-colors ${(lang === 'javascript' ? 'js' : lang) === codeTab
                                                    ? 'bg-blue-600 text-white'
                                                    : 'text-gray-500 hover:text-gray-300'
                                                    }`}
                                            >
                                                {lang}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div className="bg-blue-500/20 p-1 rounded-full">
                                <CheckCircle size={14} className="text-blue-400" />
                            </div>
                        </div>

                        <div className="flex-1 overflow-hidden relative bg-white">
                            {/* VISUAL PREVIEW */}
                            <div className={`w-full h-full ${viewMode === 'preview' ? 'block' : 'hidden'}`}>
                                <PreviewFrame code={currentQuestion.correctCode} isRestricted={true} />
                            </div>

                            {/* CODE EDITOR */}
                            <div className={`w-full h-full bg-[#1e293b] ${viewMode === 'code' ? 'block' : 'hidden'}`}>
                                <Editor
                                    height="100%"
                                    language={codeTab === 'js' ? 'javascript' : codeTab}
                                    value={currentQuestion.correctCode[codeTab]}
                                    theme="vs-dark"
                                    options={{
                                        readOnly: true,
                                        minimap: { enabled: false },
                                        fontSize: 13,
                                        padding: { top: 16 },
                                        lineNumbers: 'on',
                                        fontFamily: "'JetBrains Mono', 'Fira Code', monospace"
                                    }}
                                />
                            </div>
                        </div>
                    </div>
                </div>

                {/* --- 4. DETAILED METRICS --- */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                    <Donut
                        score={currentScore.structure}
                        color="stroke-green-500"
                        label="DOM CORRECTNESS"
                        subLabel={`Structure matches ${currentScore.structure}%.`}
                    />
                    <Donut
                        score={currentScore.content}
                        color="stroke-indigo-400"
                        label="TEXT SIMILARITY"
                        subLabel={`Content matches ${currentScore.content}%.`}
                    />
                    <Donut
                        score={currentScore.style}
                        color="stroke-orange-400"
                        label="PIXEL SIMILARITY"
                        subLabel="Style matches computed layout."
                    />
                </div>
            </div>
        </div>
    );
};

export default HtmlCssResult;
